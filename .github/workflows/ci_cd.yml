name: ci-cd

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ap-southeast-2
      TF_IN_AUTOMATION: "true"
      GLUE_SCRIPT_BUCKET: ${{ secrets.GLUE_SCRIPT_BUCKET }}
      GLUE_SCRIPT_KEY: "glue/transform_raw_to_curated.py"
      EC2_HOST: ${{ secrets.EC2_HOST }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install -r requirements.txt

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: infra/terraform
        run: terraform init

      - name: Terraform Plan
        working-directory: infra/terraform
        run: terraform plan -out=tfplan
        env:
          TF_VAR_raw_bucket_name: ${{ secrets.S3_RAW_BUCKET }}
          TF_VAR_curated_bucket_name: ${{ secrets.S3_CURATED_BUCKET }}
          TF_VAR_glue_script_s3_path: s3://${{ env.GLUE_SCRIPT_BUCKET }}/${{ env.GLUE_SCRIPT_KEY }}
          TF_VAR_aws_region: ${{ env.AWS_REGION }}
          TF_VAR_airflow_key_name: ${{ secrets.AIRFLOW_KEY_NAME }}
          TF_VAR_airflow_instance_type: ${{ secrets.AIRFLOW_INSTANCE_TYPE }}

      - name: Terraform Apply
        if: ${{ vars.TF_APPLY == 'true' }}
        working-directory: infra/terraform
        run: terraform apply -auto-approve tfplan
        env:
          TF_VAR_raw_bucket_name: ${{ secrets.S3_RAW_BUCKET }}
          TF_VAR_curated_bucket_name: ${{ secrets.S3_CURATED_BUCKET }}
          TF_VAR_glue_script_s3_path: s3://${{ env.GLUE_SCRIPT_BUCKET }}/${{ env.GLUE_SCRIPT_KEY }}
          TF_VAR_aws_region: ${{ env.AWS_REGION }}
          TF_VAR_airflow_key_name: ${{ secrets.AIRFLOW_KEY_NAME }}
          TF_VAR_airflow_instance_type: ${{ secrets.AIRFLOW_INSTANCE_TYPE }}

      - name: Upload Glue script
        if: ${{ vars.TF_APPLY == 'true' && env.GLUE_SCRIPT_BUCKET != '' }}
        run: aws s3 cp glue_jobs/transform_raw_to_curated.py s3://${GLUE_SCRIPT_BUCKET}/${GLUE_SCRIPT_KEY}

      - name: Deploy Airflow to EC2
        if: ${{ vars.TF_APPLY == 'true' && env.EC2_HOST != '' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            set -e
            if [ ! -d /opt/airflow/repo ]; then
              git clone ${{ secrets.REPO_SSH_URL }} /opt/airflow/repo
            fi
            cd /opt/airflow/repo
            git fetch --all
            git reset --hard origin/main
            docker compose up -d --build
